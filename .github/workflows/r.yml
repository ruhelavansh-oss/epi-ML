# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support docs.
# See https://github.com/r-lib/actions/tree/master/examples#readme for
# additional example workflows available for the R community.

name: R

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        r-version: ['4.4.2', '4.5.2']

    steps:
      - uses: actions/checkout@v4

      - name: Set up R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Install epiml package dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          working-directory: packages/epiml
          extra-packages: rcmdcheck

      - name: Check epiml package
        uses: r-lib/actions/check-r-package@v2
        with:
          working-directory: packages/epiml

      - name: Verify R scripts parse correctly
        run: |
          r_files <- list.files(
            c("code", "scripts", "surveillance"),
            pattern = "\\.[Rr]$", recursive = TRUE, full.names = TRUE
          )
          if (length(r_files) == 0) {
            message("No .R files found.")
          } else {
            errors <- character()
            for (f in r_files) {
              tryCatch(
                parse(file = f),
                error = function(e) {
                  errors <<- c(errors, paste0(f, ": ", conditionMessage(e)))
                }
              )
            }
            if (length(errors) > 0) {
              stop("Parse errors found:\n", paste(errors, collapse = "\n"))
            } else {
              message("All ", length(r_files), " R scripts parsed successfully.")
            }
          }
        shell: Rscript {0}
