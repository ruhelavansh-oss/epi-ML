---
title: "CPADS 2021-2022 eBAC Analysis Report"
subtitle: "Methodological Audit, Verification, and Interpretation"
author: "Vansh Singh Ruhela"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
  pdf_document:
    toc: true
    number_sections: true
    keep_tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(survey)

find_root <- function(start = getwd()) {
  cur <- normalizePath(start, winslash = "/", mustWork = FALSE)
  for (i in seq_len(8)) {
    if (file.exists(file.path(cur, "analysis", "lib", "config_paths.R"))) return(cur)
    parent <- dirname(cur)
    if (identical(parent, cur)) break
    cur <- parent
  }
  stop("Project root not found from working directory")
}

project_root <- find_root()
source(file.path(project_root, "analysis", "lib", "config_paths.R"))
paths <- get_paths()

data_dir <- paths$project_root
output_dir <- paths$output_private_dir
reports_dir <- paths$output_public_dir
cleaned_path <- file.path(paths$cleaned_dir, "cpads_pumf_wrangled.rds")

required_outputs <- c(
  "ebac_data_quality_checks.csv",
  "ebac_model_samples.csv",
  "ebac_weighted_summaries.csv",
  "ebac_distribution_unweighted.csv",
  "ebac_logistic_or_primary.csv",
  "ebac_logistic_or_sensitivity_with_heavy.csv",
  "ebac_linear_coefficients_primary.csv",
  "ebac_linear_coefficients_sensitivity_with_heavy.csv",
  "ebac_missingness_weighted.csv",
  "ebac_missingness_or.csv",
  "ebac_missingness_or_eligible_drinkers.csv"
)

stopifnot(file.exists(cleaned_path))
missing_files <- required_outputs[!file.exists(file.path(output_dir, required_outputs))]
if (length(missing_files) > 0) {
  stop("Missing required eBAC output files: ", paste(missing_files, collapse = ", "))
}

pumf <- readRDS(cleaned_path)
qa <- readr::read_csv(file.path(output_dir, "ebac_data_quality_checks.csv"), show_col_types = FALSE)
samples <- readr::read_csv(file.path(output_dir, "ebac_model_samples.csv"), show_col_types = FALSE)
ws <- readr::read_csv(file.path(output_dir, "ebac_weighted_summaries.csv"), show_col_types = FALSE)
dist_u <- readr::read_csv(file.path(output_dir, "ebac_distribution_unweighted.csv"), show_col_types = FALSE)
or_primary <- readr::read_csv(file.path(output_dir, "ebac_logistic_or_primary.csv"), show_col_types = FALSE)
or_sens <- readr::read_csv(file.path(output_dir, "ebac_logistic_or_sensitivity_with_heavy.csv"), show_col_types = FALSE)
lin_primary <- readr::read_csv(file.path(output_dir, "ebac_linear_coefficients_primary.csv"), show_col_types = FALSE)
lin_sens <- readr::read_csv(file.path(output_dir, "ebac_linear_coefficients_sensitivity_with_heavy.csv"), show_col_types = FALSE)
miss_w <- readr::read_csv(file.path(output_dir, "ebac_missingness_weighted.csv"), show_col_types = FALSE)
miss_or <- readr::read_csv(file.path(output_dir, "ebac_missingness_or.csv"), show_col_types = FALSE)
miss_or_elig <- readr::read_csv(file.path(output_dir, "ebac_missingness_or_eligible_drinkers.csv"), show_col_types = FALSE)
```

# 1. Executive Summary

This report audits and interprets the standalone eBAC script:

- Script reviewed: `PROJECT_ROOT/07_ebac.R`
- Data used: `PROJECT_ROOT/data/private/outputs/wrangled/cpads_pumf_wrangled.rds`
- Main principle: use **provided** PUMF eBAC variables (`ebac_tot`, `ebac_legal`) rather than recomputing eBAC from absent anthropometrics.

Key findings:

1. eBAC analysis is feasible and correctly implemented using measured PUMF fields.
2. `demq3`/`demq4` are absent, but this does not block analysis because eBAC is already included.
3. Main validity limitation is missingness: about `r scales::percent(mean(is.na(pumf$ebac_tot)), accuracy = 0.1)` of the cohort has missing `ebac_tot`.
4. Missingness is partly structural (non-drinkers) and partly non-structural (within drinkers), so estimates are domain-selected and should be interpreted accordingly.

# 2. Why eBAC Is Usable Without Height and Weight

## 2.1 Variable existence check

```{r var-check}
vars_check <- tibble(
  variable = c("ebac_tot", "ebac_legal", "alc13a", "alc13b_a", "alc13b_b", "demq3", "demq4"),
  exists_in_cleaned = variable %in% names(pumf)
)
vars_check
```

Interpretation:

- `ebac_tot` and `ebac_legal` exist and are directly analyzable.
- `demq3` and `demq4` do not exist in the PUMF, so de novo Widmark recomputation is not possible.
- This is methodologically acceptable because CPADS provides precomputed eBAC fields.

# 3. Step-by-Step Review of the Script Design

## 3.1 Inputs, outputs, and reproducibility controls

`07_ebac.R`:

- uses one deterministic input RDS,
- validates required variables,
- writes explicit CSV outputs for each analysis stage,
- performs QA checks before interpretation.

## 3.2 QA checks and their pass/fail status

```{r qa-table}
qa
```

## 3.3 Expert interpretation of QA checks

```{r qa-interpret}
qa %>%
  transmute(check_name, pass, value) %>%
  knitr::kable()
```

Critical interpretation:

1. **Pass**: eBAC fields are in valid numeric range.
2. **Pass**: off-boundary consistency between `ebac_legal` and `ebac_tot > 0.08` is perfect.
3. **Pass with nuance**: strict mismatches occur at exact `0.08` boundary due to rounding/precision behavior.
4. **Fail (expected caution)**: high overall missingness (`~45%`) means eBAC analyses are not full-cohort complete.
5. **Pass**: structural missingness pattern is coherent with alcohol-use eligibility.

# 4. Sample Accounting and Estimand Scope

```{r sample-accounting}
samples
```

Interpretation:

- Full wrangled cohort: 40,931.
- eBAC observed domain: 22,329.
- Past-12-month alcohol users: 32,369.
- Past-12-month alcohol users with eBAC observed: 22,329.

Therefore, the primary eBAC estimand is:

\[
E(\text{eBAC outcomes} \mid \text{eBAC observed domain}),
\]

not automatically \(E(\text{eBAC outcomes} \mid \text{entire CPADS cohort})\).

# 5. Descriptive eBAC Initial Results

## 5.1 Overall summaries

```{r overall-desc}
overall <- ws %>% filter(group_var == "Overall")
overall
dist_u
```

Interpretation:

- Weighted prevalence of `ebac_legal = 1` in the observed eBAC domain is approximately 0.650.
- Weighted mean `ebac_tot` is approximately 0.143 g/dL.
- Unweighted median `ebac_tot` is 0.13 g/dL; distribution is right-skewed with upper tail up to 0.5.

## 5.2 Stratified summaries (selected contrasts)

```{r stratified-contrast}
ws %>%
  filter(group_var %in% c("cannabis_any_use", "heavy_drinking_30d"),
         metric %in% c("ebac_legal_prevalence", "ebac_tot_mean")) %>%
  arrange(metric, group_var, group_level)
```

Interpretation:

- `cannabis_any_use=1` shows materially higher eBAC prevalence and mean than `cannabis_any_use=0`.
- `heavy_drinking_30d=1` is strongly associated with eBAC metrics, as expected from construct overlap.

# 6. Regression Initial Results and Scientific Interpretation

## 6.1 Primary binary model (`ebac_legal`)

```{r primary-logit}
or_primary
or_primary %>% filter(term == "cannabis_any_use")
```

Interpretation:

- Adjusted OR for cannabis (primary model): about 3.32 (95% CI roughly 3.08 to 3.57).
- This is an adjusted association within the eBAC-observed domain; it is not by itself a causal estimate.

## 6.2 Primary continuous model (`ebac_tot`)

```{r primary-linear}
lin_primary
lin_primary %>% filter(term == "cannabis_any_use")
```

Interpretation:

- Adjusted mean difference for cannabis in `ebac_tot` is about +0.058 g/dL.
- Effect remains large relative to overall mean, indicating a substantial association.

## 6.3 Sensitivity models including `heavy_drinking_30d`

```{r sensitivity-models}
or_sens %>% filter(term %in% c("cannabis_any_use", "heavy_drinking_30d"))
lin_sens %>% filter(term %in% c("cannabis_any_use", "heavy_drinking_30d"))
```

Interpretation:

- Adding `heavy_drinking_30d` sharply attenuates cannabis effects and introduces an extremely large heavy-drinking term.
- This is expected and should be treated as a **post-overlap adjustment sensitivity**, not a primary causal model, because heavy drinking and eBAC measure related alcohol intensity processes.

# 7. Missingness, Reliability, and Validity

## 7.1 Weighted missingness profile

```{r missingness-weighted}
miss_w
```

Interpretation:

- Missingness is near 100% for `alcohol_past12m=0` (structural skip pattern).
- Even among drinkers, missingness remains non-trivial.

## 7.2 Missingness models

```{r missingness-models}
miss_or %>% filter(term %in% c("alcohol_past12m", "cannabis_any_use"))
miss_or_elig %>% filter(term == "cannabis_any_use")
```

Interpretation:

1. Full missingness model is dominated by structural eligibility (`alcohol_past12m`).
2. Eligible-drinkers model still shows strong association between cannabis use and missingness.
3. This indicates plausible selection bias if one treats the observed-eBAC domain as if fully representative of all drinkers.

# 8. Independent Recalculation Check (Double-Check)

This section independently recomputes key statistics from the wrangled data and compares to saved outputs.

```{r independent-recompute}
des_legal <- svydesign(ids = ~1, weights = ~wtpumf,
                       data = pumf %>% filter(!is.na(ebac_legal)))
est_legal <- svymean(~ebac_legal, des_legal, na.rm = TRUE)
ci_legal <- confint(est_legal)

des_tot <- svydesign(ids = ~1, weights = ~wtpumf,
                     data = pumf %>% filter(!is.na(ebac_tot)))
est_tot <- svymean(~ebac_tot, des_tot, na.rm = TRUE)

df_refit <- pumf %>%
  select(ebac_legal, wtpumf, cannabis_any_use, age_group, gender,
         province_region, mental_health, physical_health) %>%
  drop_na()
fit_refit <- svyglm(
  ebac_legal ~ cannabis_any_use + age_group + gender +
    province_region + mental_health + physical_health,
  design = svydesign(ids = ~1, weights = ~wtpumf, data = df_refit),
  family = quasibinomial()
)

recalc <- tibble(
  quantity = c(
    "Weighted prevalence ebac_legal",
    "Weighted mean ebac_tot",
    "Adjusted OR cannabis -> ebac_legal"
  ),
  recomputed = c(
    as.numeric(coef(est_legal)[1]),
    as.numeric(coef(est_tot)[1]),
    exp(coef(fit_refit)["cannabis_any_use"])
  ),
  from_output = c(
    ws %>% filter(metric == "ebac_legal_prevalence", group_var == "Overall") %>% pull(estimate),
    ws %>% filter(metric == "ebac_tot_mean", group_var == "Overall") %>% pull(estimate),
    or_primary %>% filter(term == "cannabis_any_use") %>% pull(or)
  )
) %>%
  mutate(abs_diff = abs(recomputed - from_output))

recalc
```

Interpretation:

- Recomputed values match output values up to numerical tolerance.
- This supports computational correctness and reproducibility.

# 9. Overall Scientific Verdict

## 9.1 What is correct and reliable

1. Using provided eBAC fields is methodologically correct for this PUMF.
2. Model implementation and weighted estimation are internally consistent.
3. Boundary mismatch at `ebac_tot = 0.08` is a precision artifact, not a major coding defect.

## 9.2 What is limited

1. Missingness is high and non-random with respect to key covariates.
2. eBAC estimates are most defensible as domain-specific estimates (observed eBAC subset).
3. Sensitivity models with `heavy_drinking_30d` are informative but not primary for etiologic interpretation.

## 9.3 What the outcomes imply factually

1. In respondents with measured eBAC, the prevalence above the legal threshold is high.
2. Cannabis use is strongly associated with both binary and continuous eBAC outcomes after covariate adjustment.
3. Because missingness is selective, full-cohort generalization requires caution or additional correction (for example, inverse-probability weighting for observation/missingness).

# 10. Recommended Next Analytical Upgrade (Optional)

If you want stronger transportability from observed eBAC domain to the broader eligible cohort, implement an additional weighted analysis:

1. Model \(P(R=1 \mid X)\), where \(R\) indicates eBAC observed.
2. Apply inverse-probability-of-observation weights to eBAC outcome models.
3. Compare with current complete-case-domain estimates as a sensitivity framework.
