---
title: "eBAC Selection-Adjustment Report (IPW)"
subtitle: "CPADS 2021-2022: Inverse Probability of Observation Weighting"
author: "Vansh Singh Ruhela"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(survey)

find_root <- function(start = getwd()) {
  cur <- normalizePath(start, winslash = "/", mustWork = FALSE)
  for (i in seq_len(8)) {
    if (file.exists(file.path(cur, "analysis", "lib", "config_paths.R"))) return(cur)
    parent <- dirname(cur)
    if (identical(parent, cur)) break
    cur <- parent
  }
  stop("Project root not found from working directory")
}

project_root <- find_root()
source(file.path(project_root, "analysis", "lib", "config_paths.R"))
paths <- get_paths()

data_dir <- paths$project_root
output_dir <- paths$output_private_dir
cleaned_path <- file.path(paths$cleaned_dir, "cpads_pumf_wrangled.rds")

required_files <- c(
  "ebac_ipw_observation_model_or.csv",
  "ebac_ipw_weight_diagnostics.csv",
  "ebac_ipw_covariate_balance.csv",
  "ebac_ipw_logistic_or.csv",
  "ebac_ipw_linear_coefficients.csv",
  "ebac_ipw_cannabis_comparison.csv",
  "ebac_logistic_or_primary.csv",
  "ebac_linear_coefficients_primary.csv"
)

stopifnot(file.exists(cleaned_path))
missing_files <- required_files[!file.exists(file.path(output_dir, required_files))]
if (length(missing_files) > 0) {
  stop("Missing required output files: ", paste(missing_files, collapse = ", "))
}

pumf <- readRDS(cleaned_path)
obs_or <- readr::read_csv(file.path(output_dir, "ebac_ipw_observation_model_or.csv"), show_col_types = FALSE)
diag_tbl <- readr::read_csv(file.path(output_dir, "ebac_ipw_weight_diagnostics.csv"), show_col_types = FALSE)
bal_tbl <- readr::read_csv(file.path(output_dir, "ebac_ipw_covariate_balance.csv"), show_col_types = FALSE)
ipw_or <- readr::read_csv(file.path(output_dir, "ebac_ipw_logistic_or.csv"), show_col_types = FALSE)
ipw_lin <- readr::read_csv(file.path(output_dir, "ebac_ipw_linear_coefficients.csv"), show_col_types = FALSE)
can_cmp <- readr::read_csv(file.path(output_dir, "ebac_ipw_cannabis_comparison.csv"), show_col_types = FALSE)
base_or <- readr::read_csv(file.path(output_dir, "ebac_logistic_or_primary.csv"), show_col_types = FALSE)
base_lin <- readr::read_csv(file.path(output_dir, "ebac_linear_coefficients_primary.csv"), show_col_types = FALSE)
```

# 1. Objective

This report documents the **recommended next step**: selection adjustment for missing eBAC values using inverse probability of observation weighting (IPW).

Goal:

- target inference to the **eligible-drinker domain** (`alcohol_past12m = 1`) rather than only respondents with observed eBAC;
- evaluate whether complete-case eBAC results are materially biased by selective observation.

# 2. Why This Is Needed

From prior analysis:

1. eBAC is available as measured variables (`ebac_tot`, `ebac_legal`) in the PUMF.
2. Height/weight (`demq3`, `demq4`) are unavailable, so recomputation is not possible.
3. eBAC missingness is substantial and not purely random, which can induce selection bias.

Therefore IPW was added to correct for differential observation probability under conditional exchangeability assumptions.

# 3. Method

## 3.1 Target population and observation indicator

Define:

- Target domain: \(A=1\), where \(A\) is `alcohol_past12m`.
- Observation indicator: \(R=1\) if `ebac_tot` is observed, \(R=0\) otherwise.

## 3.2 Observation model

Fit logistic model in eligible drinkers:

\[
\Pr(R_i=1 \mid X_i)=\text{logit}^{-1}(\gamma_0+\gamma^\top X_i),
\]

with \(X\) containing:

- cannabis use,
- age group,
- gender,
- province/region,
- mental health,
- physical health.

## 3.3 IPW construction

For observed cases (\(R=1\)):

\[
sw_i = \frac{\Pr(R=1)}{\widehat{\Pr}(R_i=1\mid X_i)}.
\]

Combined analysis weights:

\[
w_i^{*} = w_{survey,i}\times sw_i.
\]

Weights are clipped (`p_hat` in [0.01, 0.99]) and trimmed at the 1st/99th percentiles for stability.

# 4. Observation Model Initial Results

```{r observation-model}
obs_or
```

Interpretation:

- Cannabis use and several covariates significantly predict whether eBAC is observed.
- This confirms that complete-case analysis alone may not represent the full eligible-drinker domain without adjustment.

# 5. Weight Diagnostics and Stability

```{r weight-diagnostics}
diag_tbl
```

Key diagnostics:

- Observation weights are mild (`max â‰ˆ 2.06`).
- Effective sample size changes minimally after IPW.

Conclusion: IPW is numerically stable in this dataset (no extreme-weight pathology).

# 6. Covariate Balance Improvement

```{r balance-overview}
bal_summary <- bal_tbl %>%
  group_by(variable) %>%
  summarise(
    mean_abs_diff_unadj = mean(abs_diff_unadj, na.rm = TRUE),
    mean_abs_diff_ipw = mean(abs_diff_ipw, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_abs_diff_unadj))
bal_summary
```

```{r balance-detail}
bal_tbl %>% arrange(variable, level)
```

Interpretation:

- Absolute distribution differences between observed and eligible target samples are reduced after IPW.
- This indicates the adjustment is doing what it should: reweighting observed cases to better match the eligible target covariate distribution.

# 7. Outcome Model Comparison (Observed vs IPW-Adjusted)

## 7.1 Cannabis effect comparison

```{r cannabis-comparison}
can_cmp
```

## 7.2 Full model coefficients

```{r full-model-coefs}
ipw_or %>% filter(term == "cannabis_any_use")
ipw_lin %>% filter(term == "cannabis_any_use")
```

Interpretation:

- eBAC-legal OR for cannabis:
  - observed-domain model: about 3.32
  - IPW-adjusted model: about 3.33
- eBAC-total beta for cannabis:
  - observed-domain model: about 0.0582 g/dL
  - IPW-adjusted model: about 0.0587 g/dL

The difference is very small. In this dataset, selection adjustment did not materially alter the cannabis-eBAC association magnitude.

# 8. Independent Verification Check

This chunk independently refits one key IPW workflow component and verifies agreement with saved outputs.

```{r independent-check}
d <- pumf %>%
  filter(alcohol_past12m == 1) %>%
  mutate(R = as.integer(!is.na(ebac_tot))) %>%
  select(
    R, wtpumf, ebac_legal, cannabis_any_use, age_group, gender,
    province_region, mental_health, physical_health
  ) %>%
  tidyr::drop_na(
    wtpumf, cannabis_any_use, age_group, gender,
    province_region, mental_health, physical_health
  )

obs_model_refit <- glm(
  R ~ cannabis_any_use + age_group + gender + province_region + mental_health + physical_health,
  data = d, family = binomial()
)

d <- d %>%
  mutate(
    p_hat = pmin(pmax(predict(obs_model_refit, type = "response"), 0.01), 0.99),
    sw = ifelse(R == 1, mean(R) / p_hat, NA_real_)
  )
q01 <- quantile(d$sw[d$R == 1], 0.01, na.rm = TRUE)
q99 <- quantile(d$sw[d$R == 1], 0.99, na.rm = TRUE)
d <- d %>% mutate(sw_trim = ifelse(R == 1, pmin(pmax(sw, q01), q99), NA_real_))

obs <- d %>% filter(R == 1, !is.na(ebac_legal))
des_ipw <- svydesign(ids = ~1, weights = ~I(wtpumf * sw_trim), data = obs)
fit_refit <- svyglm(
  ebac_legal ~ cannabis_any_use + age_group + gender + province_region + mental_health + physical_health,
  design = des_ipw,
  family = quasibinomial()
)

or_refit <- exp(coef(fit_refit)["cannabis_any_use"])
or_saved <- can_cmp %>%
  filter(model == "ipw_adjusted_eligible_domain", estimand == "ebac_legal OR") %>%
  pull(estimate)

tibble(or_refit = or_refit, or_saved = or_saved, abs_diff = abs(or_refit - or_saved))
```

Interpretation:

- Independent recomputation matches saved IPW output within floating-point tolerance.
- This supports computational reproducibility.

# 9. Scientific Implications

## 9.1 What changed after recommended next step

1. Selection into observed eBAC was explicitly modeled.
2. Outcome estimates were transported toward the eligible-drinker domain.
3. Covariate balance improved between observed and target domains.

## 9.2 What did not change materially

Cannabis associations with eBAC remained almost unchanged in magnitude, suggesting:

- either selection bias on these contrasts was small,
- or the modeled covariates captured most of the relevant observation mechanism.

## 9.3 Remaining limitations

1. IPW validity requires correct observation-model specification and positivity.
2. Unmeasured predictors of eBAC observation could still bias results.
3. This does not create causal identification for cannabis effects by itself; these are adjusted associational estimates.

# 10. Practical Conclusion

The recommended step has now been completed and validated:

- eBAC can be analyzed despite absent height/weight because measured eBAC fields are already in PUMF.
- Selection adjustment was implemented correctly and stably.
- Final substantive inference is robust: cannabis use is strongly associated with higher eBAC outcomes, and this association persists after selection adjustment.
