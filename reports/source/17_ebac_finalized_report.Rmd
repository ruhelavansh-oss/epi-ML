---
title: "Finalized eBAC Code-and-Initial Results Audit"
subtitle: "Full consistency review, fixes, reruns, and verified interpretation"
author: "Vansh Singh Ruhela"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: 4
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)

find_root <- function(start = getwd()) {
  cur <- normalizePath(start, winslash = "/", mustWork = FALSE)
  for (i in seq_len(8)) {
    if (file.exists(file.path(cur, "analysis", "lib", "config_paths.R"))) return(cur)
    parent <- dirname(cur)
    if (identical(parent, cur)) break
    cur <- parent
  }
  stop("Project root not found from working directory")
}

root_dir <- find_root()
source(file.path(root_dir, "analysis", "lib", "config_paths.R"))
paths <- get_paths()

out_dir <- paths$output_private_dir
rep_dir <- paths$output_public_dir

required_files <- c(
  "ebac_final_script_run_status.csv",
  "ebac_final_consistency_checks.csv",
  "ebac_final_output_coverage.csv",
  "ebac_final_output_shapes.csv",
  "ebac_final_user_guide_variable_map.csv",
  "ebac_final_user_guide_excerpt.txt",
  "ebac_final_variable_audit.csv",
  "ebac_final_key_summary.csv",
  "ebac_final_weighted_descriptives.csv",
  "ebac_final_weighted_or.csv",
  "ebac_final_ipw_comparison.csv",
  "ebac_final_causal_effects.csv",
  "ebac_final_cate.csv",
  "ebac_final_dml_results.csv",
  "ebac_final_smote_compare.csv"
)
missing_files <- required_files[!file.exists(file.path(out_dir, required_files))]
if (length(missing_files) > 0) {
  stop("Missing audit dependency files: ", paste(missing_files, collapse = ", "))
}

run_status <- read_csv(file.path(out_dir, "ebac_final_script_run_status.csv"), show_col_types = FALSE)
consistency <- read_csv(file.path(out_dir, "ebac_final_consistency_checks.csv"), show_col_types = FALSE)
coverage <- read_csv(file.path(out_dir, "ebac_final_output_coverage.csv"), show_col_types = FALSE)
shapes <- read_csv(file.path(out_dir, "ebac_final_output_shapes.csv"), show_col_types = FALSE)
var_map <- read_csv(file.path(out_dir, "ebac_final_user_guide_variable_map.csv"), show_col_types = FALSE)
var_audit <- read_csv(file.path(out_dir, "ebac_final_variable_audit.csv"), show_col_types = FALSE)
key_sum <- read_csv(file.path(out_dir, "ebac_final_key_summary.csv"), show_col_types = FALSE)
wd <- read_csv(file.path(out_dir, "ebac_final_weighted_descriptives.csv"), show_col_types = FALSE)
wor <- read_csv(file.path(out_dir, "ebac_final_weighted_or.csv"), show_col_types = FALSE)
ipcmp <- read_csv(file.path(out_dir, "ebac_final_ipw_comparison.csv"), show_col_types = FALSE)
ce <- read_csv(file.path(out_dir, "ebac_final_causal_effects.csv"), show_col_types = FALSE)
cate <- read_csv(file.path(out_dir, "ebac_final_cate.csv"), show_col_types = FALSE)
dml <- read_csv(file.path(out_dir, "ebac_final_dml_results.csv"), show_col_types = FALSE)
smcmp <- read_csv(file.path(out_dir, "ebac_final_smote_compare.csv"), show_col_types = FALSE)
user_guide_excerpt <- readLines(file.path(out_dir, "ebac_final_user_guide_excerpt.txt"))

fmt <- function(x, d = 3) formatC(x, digits = d, format = "f")
fmtp <- function(x, d = 1) paste0(formatC(100 * x, digits = d, format = "f"), "%")
```

# 1. Scope and Exact Deliverables

This report documents a full end-to-end review and repair of all eBAC scripts:

1. `PROJECT_ROOT/07_ebac.R`
2. `PROJECT_ROOT/07_ebac_ipw.R`
3. `PROJECT_ROOT/07_ebac_gender_smote_sensitivity.R`
4. `PROJECT_ROOT/07_ebac_integrations.R`

This audit includes:

- static script consistency review,
- defect fixes,
- full reruns,
- warning/error verification,
- cross-script estimate agreement checks,
- output coverage verification,
- finalized interpretation of estimands and design.

# 2. Code Review Findings and Fixes Applied

## 2.1 Findings fixed in this pass

```{r fixes-table}
fixes <- tribble(
  ~file, ~issue, ~fix_applied, ~reason,
  "PROJECT_ROOT/07_ebac_gender_smote_sensitivity.R",
  "Stale DMwR references in comments/output notes",
  "Updated comments and output notes to smotefamily consistently",
  "Avoid methodological/documentation mismatch",
  "PROJECT_ROOT/07_ebac_ipw.R",
  "Dead/incorrect intermediate covariate-balance calculation (then overwritten)",
  "Removed dead intermediate block; retained correct weighted proportion calculation",
  "Prevent confusing/incorrect intermediate logic",
  "PROJECT_ROOT/07_ebac_integrations.R",
  "Ethnicity/race naming ambiguity",
  "Explicitly mapped dvdemq6 as ethnicity and dvdemq02 as sexual orientation; added user-guide mapping output",
  "Align with CPADS user guide and prevent mislabeling",
  "PROJECT_ROOT/07_ebac_integrations.R",
  "Prior non-integer binomial warning in weighted propensity fits",
  "Weighted propensity models use quasibinomial()",
  "Correct family for non-integer prior weights; remove warning without silencing"
)
fixes
```

## 2.2 Post-fix execution status

```{r run-status}
run_status
```

Interpretation:

- All four scripts completed successfully.
- Warning-line counts are zero in all audited logs.

# 3. Race/Ethnicity Variable Verification (User Guide Grounding)

## 3.1 Why `NONE` appeared previously

The previous `NONE` signal was from a **literal variable-name scan for `race` names**. CPADS uses `dvdemq6` naming instead.

## 3.2 User-guide mapped variables

```{r user-guide-map}
var_map
```

## 3.3 User-guide excerpt captured from local PDF

```{r user-guide-excerpt, results='asis'}
cat(paste0("```\n", paste(user_guide_excerpt, collapse = "\n"), "\n```\n"))
```

## 3.4 Final variable audit after fix

```{r variable-audit}
var_audit
```

Interpretation:

- `dvdemq6` exists and is now explicitly treated as ethnicity in final outputs.
- `dvdemq02` is explicitly treated as sexual orientation.
- `demq5` exists and is international-student status.

# 4. Output Contract Verification

## 4.1 Output coverage by script

```{r output-coverage}
coverage %>% group_by(script) %>% summarise(outputs = n(), all_exist = all(exists), .groups = "drop")
```

```{r output-coverage-detail}
coverage %>% arrange(script, output)
```

## 4.2 Output shape/index verification

```{r output-shapes}
shapes %>% select(file, rows, cols) %>% arrange(file)
```

Interpretation:

- All declared outputs exist.
- File row/column structures are present and readable.

# 5. Script-by-Script Procedural Trace (No Step Skipping)

## 5.1 `PROJECT_ROOT/07_ebac.R` (Phase 7b)

Operations performed:

1. Load wrangled PUMF RDS and verify required variables.
2. Run QA checks:
   - eBAC range, threshold consistency, missingness burden, structural missingness, overlap, weight positivity.
3. Build sample accounting table.
4. Produce weighted descriptive estimates (`ebac_legal` prevalence and `ebac_tot` means).
5. Fit weighted primary and sensitivity models:
   - logistic (`ebac_legal`) and linear (`ebac_tot`), with/without heavy-drinking sensitivity term.
6. Fit missingness models for observed-domain diagnosis.
7. Write 11 output CSVs.

Primary estimate from this script:

```{r phase7b-key}
read_csv(file.path(out_dir, "ebac_logistic_or_primary.csv"), show_col_types = FALSE) %>%
  filter(term == "cannabis_any_use")
```

## 5.2 `PROJECT_ROOT/07_ebac_ipw.R` (Phase 7c)

Operations performed:

1. Restrict to alcohol-eligible domain (`alcohol_past12m == 1`).
2. Model observation indicator `R = I(!is.na(ebac_tot))`.
3. Compute stabilized IPW, clip and trim (1st/99th percentiles).
4. Diagnose weight stability and effective sample size.
5. Compute covariate-balance tables (observed vs eligible target).
6. Fit observed-domain vs IPW-adjusted weighted outcome models.
7. Export cannabis-effect comparison table and diagnostics.

Key comparison output:

```{r phase7c-key}
read_csv(file.path(out_dir, "ebac_ipw_cannabis_comparison.csv"), show_col_types = FALSE)
```

## 5.3 `PROJECT_ROOT/07_ebac_gender_smote_sensitivity.R` (Phase 7d)

Operations performed:

1. Fit survey-weighted interaction model (`cannabis_any_use * gender`) for `ebac_legal`.
2. Run joint Wald interaction test.
3. Produce model-based marginal predicted probabilities grid.
4. Run SMOTE predictive sensitivity with `smotefamily::SMOTE` on one-hot encoded matrix.
5. Compare cannabis-related terms pre/post-SMOTE.
6. Export interaction and SMOTE outputs.

Key interaction and SMOTE outputs:

```{r phase7d-key}
read_csv(file.path(out_dir, "ebac_gender_interaction_tests.csv"), show_col_types = FALSE)
read_csv(file.path(out_dir, "ebac_smote_compare.csv"), show_col_types = FALSE)
```

## 5.4 `PROJECT_ROOT/07_ebac_integrations.R` (Phase 7e integrated)

Operations performed:

1. Variable audit + user-guide mapping output.
2. Domain/sample accounting + QA checks.
3. Weighted descriptive estimates including ethnicity and sexual-orientation group summaries when present.
4. Weighted main and interaction regression models.
5. IPW transport-adjusted models and comparison.
6. Causal contrasts (ATE/ATT/ATC) with bootstrap SE and CIs.
7. CATE subgroup contrasts.
8. DML random-forest sensitivity (ATE/ATTE).
9. SMOTE sensitivity and cannabis-term extraction.
10. Crosswalk to prior eBAC outputs and final key summary artifact.

Key final summary:

```{r final-key-summary}
key_sum
```

# 6. Cross-Script Numerical Consistency Checks

```{r consistency-checks}
consistency
```

Interpretation:

- All programmed cross-script checks passed.
- Core OR and descriptive metrics are numerically consistent across phase scripts and final integrated outputs.

# 7. Final Statistical Interpretation (What the Estimates Mean)

## 7.1 Study design

- Data type: observational survey (CPADS PUMF), not randomized experiment.
- Treatment/exposure: `cannabis_any_use` (binary).
- Outcomes:
  - `ebac_legal` (binary legal-threshold indicator)
  - `ebac_tot` (continuous level)
- Primary inferential models: survey-weighted.
- Causal effects: model-based, assumption-conditional.

## 7.2 Key final estimates

```{r key-estimates-block}
wor %>% filter(model == "weighted_main", term == "cannabis_any_use") %>%
  select(model, term, or, or_lower95, or_upper95, p_value)
ipcmp
ce
dml
smcmp
```

Interpretation:

1. Weighted observed-domain prevalence of `ebac_legal = 1` is approximately `r fmtp(as.numeric(key_sum$value[key_sum$key == 'weighted_ebac_legal_prevalence_observed_domain']))`.
2. Weighted main model cannabis effect on `ebac_legal` is OR `r fmt(as.numeric(key_sum$value[key_sum$key == 'weighted_main_or_cannabis_ebac_legal']), 3)`.
3. IPW-adjusted cannabis OR is `r fmt(as.numeric(key_sum$value[key_sum$key == 'selection_adjusted_or_cannabis_ebac_legal']), 3)`, very close to observed-domain weighted OR.
4. Causal contrasts (assumption-dependent) indicate an absolute-risk increase around 0.26 for `ebac_legal` under cannabis exposure.
5. DML sensitivity gives similar effect magnitude (ATE/ATTE around 0.24â€“0.25).
6. SMOTE sensitivity changes class balance but does not reverse cannabis effect direction.

## 7.3 Meaning of prevalence, OR, and ATE

- Prevalence: proportion with outcome in target domain.
- OR: multiplicative change in odds (not direct probability ratio).
- ATE: absolute risk difference under causal-identification assumptions.

# 8. Remaining Limitations (Post-Fix)

1. eBAC missingness remains substantial; estimates are domain-selected and then transported with modeled assumptions.
2. Causal estimates require exchangeability, positivity, and model adequacy; randomization is absent.
3. DML and SMOTE are sensitivity layers, not replacements for primary survey-weighted inference.
4. Race harmonization across external studies still requires careful metadata work because CPADS uses `dvdemq6` naming and category definitions.

# 9. Reproducibility Commands

```bash
Rscript PROJECT_ROOT/07_ebac.R
Rscript PROJECT_ROOT/07_ebac_ipw.R
Rscript PROJECT_ROOT/07_ebac_gender_smote_sensitivity.R
Rscript PROJECT_ROOT/07_ebac_integrations.R
Rscript -e "rmarkdown::render('PROJECT_ROOT/reports/source/17_ebac_finalized_report.Rmd', output_dir='PROJECT_ROOT/reports/public')"
```

All conclusions in this finalized report are directly traceable to files in `PROJECT_ROOT/data/private/outputs`.
